---
- hosts: all

  vars:
    ansible_python_interpreter: /usr/bin/python3
    ufw__default_incoming_policy: deny
    ufw__default_outgoing_policy: deny
    ufw__rules:
      - rule: allow
        proto: udp
        direction: out
        to_port: 53
      - rule: allow
        proto: udp
        direction: out
        to_port: 123
      - rule: allow
        proto: tcp
        direction: out
        to_port: 22
      - rule: allow
        proto: tcp
        direction: out
        to_port: 80
      - rule: allow
        proto: tcp
        direction: out
        to_port: 443
      - rule: allow
        proto: tcp
        direction: in
        to_port: 22
      - rule: allow
        proto: tcp
        direction: in
        to_port: 80
      - rule: allow
        proto: tcp
        direction: in
        to_port: 443

  roles:
    - role: ufw
    - role: utils
    - role: sudo
      tags: users
    - role: users
      groups_to_create:
        - deploy
      users:
        - name: admin
          groups:
            - sudo
            - deploy
          authorized_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        - name: ci
          groups:
            - deploy
          authorized_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        - name: my_app
          system: yes
          create_home: no
      tags: users
    - role: postgresql
      database:
        name: my_app_prod
      user:
        name: my_app
        password: "123456"
    - role: phoenix-app
      app_name: my_app
      service:
        user: my_app
        group: my_app
      deploy:
        group: deploy
      database:
        name: my_app_prod
        user: my_app
        password: "123456"
      secret_key_base: rQF1/xmb9GphVLG0CjueWKMsWsEkyV1kv0hSQaLL1sin5hHH7OQTbHqISu55Ayz9
